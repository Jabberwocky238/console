apiVersion: v1
kind: ConfigMap
metadata:
  name: bind9-config
  namespace: kube-system
data:
  named.conf: |
    # TSIG 密钥配置（用于 cert-manager RFC2136 动态更新）
    key "certmanager" {
        algorithm hmac-sha256;
        secret "${TSIG_SECRET}";
    };

    options {
        directory "/var/cache/bind";
        listen-on port 53 { any; };
        listen-on-v6 port 53 { any; };
        allow-query { any; };
        recursion yes;
        allow-recursion { any; };

        forwarders {
            223.5.5.5;
            8.8.8.8;
        };

        dnssec-validation auto;
    };

    # GeoIP 配置
    geoip-directory "/usr/share/GeoIP";

    # 日志配置
    logging {
        channel default_log {
            file "/var/log/named/named.log" versions 3 size 5m;
            severity info;
            print-time yes;
            print-category yes;
        };
        category default { default_log; };
        category queries { default_log; };
    };

    # 中国大陆视图
    view "china" {
        match-clients { geoip db country country CN; };

        zone "${DOMAIN}" {
            type master;
            file "/var/cache/bind/domain.cn";
            allow-update { key "certmanager"; };
        };

        zone "${WORKER_DOMAIN}" {
            type master;
            file "/var/cache/bind/worker.cn";
            allow-update { key "certmanager"; };
        };
    };

    # 美国视图
    view "usa" {
        match-clients { geoip db country country US; };

        zone "${DOMAIN}" {
            type master;
            file "/var/cache/bind/domain.us";
            allow-update { key "certmanager"; };
        };

        zone "${WORKER_DOMAIN}" {
            type master;
            file "/var/cache/bind/worker.us";
            allow-update { key "certmanager"; };
        };
    };

    # 其他地区视图（国际）
    view "world" {
        match-clients { any; };

        zone "${DOMAIN}" {
            type master;
            file "/var/cache/bind/domain.world";
            allow-update { key "certmanager"; };
        };

        zone "${WORKER_DOMAIN}" {
            type master;
            file "/var/cache/bind/worker.world";
            allow-update { key "certmanager"; };
        };
    };

  # 主域名 - 中国区域文件
  domain.cn: |
    $TTL 60
    @       IN      SOA     ns1.${DOMAIN}. admin.${DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${DOMAIN}.
    @       IN      A       ${CN_IP}
    *       IN      A       ${CN_IP}

  # 主域名 - 美国区域文件
  domain.us: |
    $TTL 60
    @       IN      SOA     ns1.${DOMAIN}. admin.${DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${DOMAIN}.
    @       IN      A       ${US_IP}
    *       IN      A       ${US_IP}

  # 主域名 - 国际区域文件
  domain.world: |
    $TTL 60
    @       IN      SOA     ns1.${DOMAIN}. admin.${DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${DOMAIN}.
    @       IN      A       ${DEFAULT_IP}
    *       IN      A       ${DEFAULT_IP}

  # Worker 域名 - 中国区域文件
  worker.cn: |
    $TTL 60
    @       IN      SOA     ns1.${WORKER_DOMAIN}. admin.${WORKER_DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${WORKER_DOMAIN}.
    *       IN      A       ${CN_WORKER_IP}

  # Worker 域名 - 美国区域文件
  worker.us: |
    $TTL 60
    @       IN      SOA     ns1.${WORKER_DOMAIN}. admin.${WORKER_DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${WORKER_DOMAIN}.
    *       IN      A       ${US_WORKER_IP}

  # Worker 域名 - 国际区域文件
  worker.world: |
    $TTL 60
    @       IN      SOA     ns1.${WORKER_DOMAIN}. admin.${WORKER_DOMAIN}. (
                            2024021101 ; Serial
                            3600       ; Refresh
                            1800       ; Retry
                            604800     ; Expire
                            60 )       ; Minimum TTL

    @       IN      NS      ns1.${WORKER_DOMAIN}.
    *       IN      A       ${DEFAULT_WORKER_IP}

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bind9
  namespace: kube-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bind9
  namespace: kube-system
  labels:
    app: bind9
spec:
  replicas: 2
  selector:
    matchLabels:
      app: bind9
  template:
    metadata:
      labels:
        app: bind9
    spec:
      serviceAccountName: bind9
      initContainers:
      - name: download-geoip
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          wget -O /geoip/GeoIP.dat https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb
          echo "GeoIP database downloaded"
        volumeMounts:
        - name: geoip-data
          mountPath: /geoip
      - name: copy-zones
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          cp /zones-ro/* /var/cache/bind/
          chmod 644 /var/cache/bind/*
          echo "Zone files copied to writable directory"
        volumeMounts:
        - name: zones-ro
          mountPath: /zones-ro
        - name: cache
          mountPath: /var/cache/bind
      containers:
      - name: bind9
        image: ubuntu/bind9:9.18-22.04_stable
        ports:
        - containerPort: 53
          name: dns-udp
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - dig @127.0.0.1 example.com +short
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - dig @127.0.0.1 example.com +short
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: config
          mountPath: /etc/bind/named.conf
          subPath: named.conf
        - name: geoip-data
          mountPath: /usr/share/GeoIP
        - name: cache
          mountPath: /var/cache/bind
        - name: logs
          mountPath: /var/log/named
      volumes:
      - name: config
        configMap:
          name: bind9-config
          items:
          - key: named.conf
            path: named.conf
      - name: zones-ro
        configMap:
          name: bind9-config
          items:
          - key: domain.cn
            path: domain.cn
          - key: domain.us
            path: domain.us
          - key: domain.world
            path: domain.world
          - key: worker.cn
            path: worker.cn
          - key: worker.us
            path: worker.us
          - key: worker.world
            path: worker.world
      - name: geoip-data
        emptyDir: {}
      - name: cache
        emptyDir: {}
      - name: logs
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: bind9
  namespace: kube-system
  labels:
    app: bind9
spec:
  type: LoadBalancer
  selector:
    app: bind9
  ports:
  - name: dns-udp
    port: 53
    targetPort: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    targetPort: 53
    protocol: TCP
